(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{451:function(s,t,a){"use strict";a.r(t);var e=a(51),r=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"mysql高可用架构之innodb-cluster"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql高可用架构之innodb-cluster"}},[s._v("#")]),s._v(" MySQL高可用架构之InnoDB Cluster")]),s._v(" "),a("h2",{attrs:{id:"mysql-innodb-cluster简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql-innodb-cluster简介"}},[s._v("#")]),s._v(" MySQL Innodb Cluster简介")]),s._v(" "),a("p",[s._v("Cluster是这个高可用方案中的一个虚拟节点，它会在组的所有成员上创建一个名为mysql_innodb_cluster_metadata的数据库，存储集群的元数据信息，包括集群信息、集群成员、组信息、连接的MySQL Router等信息，以提供MySQL Router查询。它相当于对组上的成员做了一层逻辑上的封装，以一个集群的模式展现出来，各节点的状态与对应实例在组中成员的状态实时同步，但是集群的节点与组的成员只在创建集群时同步，后期组的成员变更并不自动同步到集群中，可以在集群中做手动的节点增减，这样使得面向应用端的具体实例实现了更可控更灵活的高可用。")]),s._v(" "),a("h2",{attrs:{id:"mysql-router-简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql-router-简介"}},[s._v("#")]),s._v(" MySQL Router 简介")]),s._v(" "),a("p",[s._v("MySQL Router可以说是MySQL Proxy的升级产品，是介于Client与MySQL实例之间的程序。MySQL Router会周期性的访问Cluster创建的mysql_innodb_cluster_metadata库中的元数据获取集群成员信息,再通过performance_schema的系统表获取可连接实例及其状态，启动后会产生2个端口，分别对应集群的读写节点和只读节点，它使应用能够透明的连接Innodb Cluster下的数据库，即使集群发生failover或者增减成员也不用修改应用配置。在2.1.3及之前的版本，单个MySQL Router实例只支持上限500个连接数，需要根据实际连接数情况，部署足够数量的Router节点。")]),s._v(" "),a("h2",{attrs:{id:"使用mysql-shell"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用mysql-shell"}},[s._v("#")]),s._v(" 使用MySQL Shell")]),s._v(" "),a("p",[s._v("MySQL Shell是新的MySQL客户端工具，支持JavaScript、Python和MySQL脚本，用作搭建InnodbCluster。")]),s._v(" "),a("h2",{attrs:{id:"架构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#架构"}},[s._v("#")]),s._v(" 架构")]),s._v(" "),a("p",[a("img",{attrs:{src:"/img/mysql/innodb_cluster_overview.png",alt:""}})]),s._v(" "),a("h2",{attrs:{id:"部署"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#部署"}},[s._v("#")]),s._v(" 部署")]),s._v(" "),a("h3",{attrs:{id:"安装"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[s._v("#")]),s._v(" 安装")]),s._v(" "),a("p",[s._v("在3个node上执行安装。")]),s._v(" "),a("div",{staticClass:"language-sh line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("yum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" https://repo.mysql.com//mysql57-community-release-el7.rpm -y\nyum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" mysql-community-server -y\nyum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" mysql-shell -y\nyum "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" mysql-router -y\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("h3",{attrs:{id:"参数配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参数配置"}},[s._v("#")]),s._v(" 参数配置")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("Variable")]),s._v(" "),a("th",[s._v("Required Value")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("binlog_checksum")]),s._v(" "),a("td",[s._v("NONE")])]),s._v(" "),a("tr",[a("td",[s._v("enforce_gtid_consistency")]),s._v(" "),a("td",[s._v("ON")])]),s._v(" "),a("tr",[a("td",[s._v("gtid_mode")]),s._v(" "),a("td",[s._v("ON")])]),s._v(" "),a("tr",[a("td",[s._v("log_bin")]),s._v(" "),a("td",[s._v("1")])]),s._v(" "),a("tr",[a("td",[s._v("log_slave_updates")]),s._v(" "),a("td",[s._v("ON")])]),s._v(" "),a("tr",[a("td",[s._v("master_info_repository")]),s._v(" "),a("td",[s._v("TABLE")])]),s._v(" "),a("tr",[a("td",[s._v("relay_log_info_repository")]),s._v(" "),a("td",[s._v("TABLE")])]),s._v(" "),a("tr",[a("td",[s._v("transaction_write_set_extraction")]),s._v(" "),a("td",[s._v("XXHASH64")])])])]),s._v(" "),a("h3",{attrs:{id:"权限配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#权限配置"}},[s._v("#")]),s._v(" 权限配置")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" mysql_innodb_cluster_metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" your_user"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" performance_schema"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("global_status "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" your_user"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" performance_schema"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("replication_applier_configuration "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" your_user"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" performance_schema"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("replication_applier_status "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" your_user"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" performance_schema"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("replication_applier_status_by_coordinator "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" your_user"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" performance_schema"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("replication_applier_status_by_worker "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" your_user"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" performance_schema"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("replication_connection_configuration "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" your_user"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" performance_schema"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("replication_connection_status "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" your_user"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" performance_schema"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("replication_group_member_stats "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" your_user"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" performance_schema"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("replication_group_members "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" your_user"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" performance_schema"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("threads "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v(" your_user"),a("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@'%'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WITH")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GRANT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("OPTION")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h3",{attrs:{id:"cluster配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cluster配置"}},[s._v("#")]),s._v(" cluster配置")]),s._v(" "),a("ol",[a("li",[s._v("登录mysqlsh - "),a("code",[s._v("mysqlsh --log-level=DEBUG3")])]),s._v(" "),a("li",[s._v("检查node配置 - "),a("code",[s._v("mysql-js> dba.checkInstanceConfiguration('root@localhost:3306')")])]),s._v(" "),a("li",[s._v("创建mycluster集群 - "),a("code",[s._v("mysql-js> var cluster = dba.createCluster('prodCluster')")])]),s._v(" "),a("li",[s._v("添加实例 - "),a("code",[s._v("mysql-js> cl.addInstance('repl@node2:3306')")])]),s._v(" "),a("li",[s._v("查看cluster - "),a("code",[s._v("cl.status()")])])]),s._v(" "),a("h3",{attrs:{id:"mysql-router配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql-router配置"}},[s._v("#")]),s._v(" mysql router配置")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("初始化 - "),a("code",[s._v("shell> mysqlrouter --bootstrap repl@node1:3306 --user=mysqlrouter")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("the cluster 'mycluster' can be reached by connecting to:\n\n## MySQL Classic protocol\n\n- Read/Write Connections: localhost:6446\n- Read/Only Connections:  localhost:6447\n\n## MySQL X protocol\n\n- Read/Write Connections: localhost:64460\n- Read/Only Connections:  localhost:64470\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("启动mysql router - "),a("code",[s._v("shell> mysqlrouter &")])])])]),s._v(" "),a("h2",{attrs:{id:"基准测试"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#基准测试"}},[s._v("#")]),s._v(" 基准测试")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("准备环境 - "),a("code",[s._v("create database proxytest default character set utf8;")])])]),s._v(" "),a("li",[a("p",[s._v("执行测试 - "),a("code",[s._v("sysbench --test=/usr/share/doc/sysbench/tests/db/oltp.lua --mysql-host=node1 --mysql-port=3306 --mysql-user=proxysql --mysql-password=proxysql --mysql-db=proxytest --oltp-tables-count=10 --oltp-table-size=1000000 --report-interval=20 --oltp-dist-type=uniform --rand-init=on --max-requests=0 --oltp-read-only=off --max-time=120 --num-threads=16 prepare")])])]),s._v(" "),a("li",[a("p",[s._v("测试结果")]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("MySQL架构")]),s._v(" "),a("th",[s._v("tps")]),s._v(" "),a("th",[s._v("qps")]),s._v(" "),a("th",[s._v("95% response time")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("单mysql实例 直连")]),s._v(" "),a("td",[s._v("2341")]),s._v(" "),a("td",[s._v("42138")]),s._v(" "),a("td",[s._v("8.78ms")])]),s._v(" "),a("tr",[a("td",[s._v("innodb cluster 直连")]),s._v(" "),a("td",[s._v("1935")]),s._v(" "),a("td",[s._v("34844")]),s._v(" "),a("td",[s._v("9.77ms")])]),s._v(" "),a("tr",[a("td",[s._v("innodb cluster router")]),s._v(" "),a("td",[s._v("1529")]),s._v(" "),a("td",[s._v("27529")]),s._v(" "),a("td",[s._v("13.02ms")])])])])]),s._v(" "),a("li",[a("p",[s._v("通过mysql router还是有一定性能损失，tps减少20%。")])])])])}),[],!1,null,null,null);t.default=r.exports}}]);