(window.webpackJsonp=window.webpackJsonp||[]).push([[58],{419:function(s,t,e){"use strict";e.r(t);var a=e(51),r=Object(a.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"redis-cluster-维护手册"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#redis-cluster-维护手册"}},[s._v("#")]),s._v(" Redis Cluster 维护手册")]),s._v(" "),e("h2",{attrs:{id:"安装"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装"}},[s._v("#")]),s._v(" 安装")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ./bin/redis-trib.rb create --replicas 0 xx.xx.5.248:6379 xx.xx.5.249:6379 xx.xx.5.250:6379")]),s._v("\n/usr/share/rubygems/rubygems/core_ext/kernel_require.rb:55:in "),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("require': cannot load such "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v(" -- redis "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("LoadError"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nfrom /usr/share/rubygems/rubygems/core_ext/kernel_require.rb:55:in "),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("require'\nfrom ./bin/redis-trib.rb:25:in "),e("span",{pre:!0,attrs:{class:"token variable"}},[e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("main"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("`\n需要执行安装gem "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" redis接口\nhttps://rubygems.global.ssl.fastly.net/gems/redis-3.3.5.gem\ngem "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -l redis-3.3.5.gem\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("wget")]),s._v(" https://archive.apache.org/dist/maven/maven-3/3.1.1/binaries/apache-maven-3.1.1-bin.zip\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("unzip")]),s._v(" apache-maven-3.1.1-bin.zip\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mv")]),s._v(" apache-maven-3.1.1 /usr/local/\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vi")]),s._v(" /etc/profile加上"),e("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("PATH")]),s._v("\n安装jdk1.8\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("rpm")]),s._v(" -ivh jdk-8u66-linux-x64.rpm\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" YCSB/\nmvn -pl com.yahoo.ycsb:redis-binding -am package\n性能测试\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br")])]),e("h2",{attrs:{id:"添加slaver节点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#添加slaver节点"}},[s._v("#")]),s._v(" 添加Slaver节点")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("./bin/redis-trib.rb add-node --slave --master-id f21ce8e4d7b00f5835089f640770b991f7c509c6 new_host:new_port existing_host:existing_port\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"删除slaver节点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#删除slaver节点"}},[s._v("#")]),s._v(" 删除Slaver节点")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("./bin/redis-trib.rb del-node host:port node_id\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"增加master节点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#增加master节点"}},[s._v("#")]),s._v(" 增加Master节点")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("./bin/redis-trib.rb add-node --master-id f21ce8e4d7b00f5835089f640770b991f7c509c6 new_host:new_port existing_host:existing_port\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"重分布"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#重分布"}},[s._v("#")]),s._v(" 重分布")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("./redis-trib.rb reshard --from all --to dfbcc0389026414dfa0851a11d04e5a1cc615242 --slots 3500 --timeout 3600 --pipeline 1000 172.xx.6.xx:6379\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("如果在迁移过程遇到下面这样的错误：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("Check "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("open")]),s._v(" slots"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("WARNING"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Node "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.3:6379 has slots "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" importing state "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("5461")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(".\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("WARNING"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Node "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("192.168")]),s._v(".0.5:6380 has slots "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" migrating state "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("5461")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(".\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("WARNING"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" The following slots are open: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("5461")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("可以考虑使用命令"),e("code",[s._v("redis-trib.rb fix 192.168.0.3:6379")]),s._v("尝试修复。需要显示有节点处于migrating或importing状态，可以登录到相应的节点，使用命令"),e("code",[s._v("cluster setslot 5461 stable")]),s._v("修改，参数5461为问题显示的slot的ID。")]),s._v(" "),e("p",[s._v("错误二：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("Moving slot "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("5461")]),s._v(" from "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172")]),s._v(".x.x.99:6379 to "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172")]),s._v(".x.x.100:6379: \n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("ERR"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" Calling MIGRATE: ERR Syntax error, try CLIENT "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("LIST "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" KILL ip:port "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" GETNAME "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" SETNAME connection-name"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("解决办法：")]),s._v(" "),e("p",[s._v("ruby gem安装的redis库，版本不能使用最新的4.0，否则redis-trib.rb reshard 127.0.0.1:7000 重新分片时会报语法错误。")]),s._v(" "),e("ul",[e("li",[s._v("卸载最新redis库，gem uninstall redis")]),s._v(" "),e("li",[s._v("安装3.x版本，gem install redis -v 3.3.5 测试3.2.1到3.3.5都可以，4.x以上的分片报错。")])]),s._v(" "),e("h2",{attrs:{id:"删除master节点"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#删除master节点"}},[s._v("#")]),s._v(" 删除master节点")]),s._v(" "),e("ol",[e("li",[s._v("移走节点slot")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("redis-trib.rb reshard --from dfbcc0389026414dfa0851a11d04e5a1cc615242 --to f21ce8e4d7b00f5835089f640770b991f7c509c6 --slots 1300 --timeout 10000 --pipeline 1000 172.x.x.99:6379\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ol",{attrs:{start:"2"}},[e("li",[s._v("del-node")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("./redis-trib.rb del-node 172.x.x.99:6379 dfbcc0389026414dfa0851a11d04e5a1cc615242\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ol",{attrs:{start:"3"}},[e("li",[s._v("rebalance")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("redis-trib.rb rebalance --pipeline 10000 --auto-weights --timeout 10000 172.x.x.100:6379\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h2",{attrs:{id:"外部redis数据导入集群"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#外部redis数据导入集群"}},[s._v("#")]),s._v(" 外部redis数据导入集群")]),s._v(" "),e("p",[s._v("import命令可以把外部的redis节点数据导入集群。导入的流程如下：")]),s._v(" "),e("ol",[e("li",[s._v("通过load_cluster_info_from_node方法转载集群信息，check_cluster方法检查集群是否健康。")]),s._v(" "),e("li",[s._v("连接外部redis节点，如果外部节点开启了cluster_enabled，则提示错误。")]),s._v(" "),e("li",[s._v("通过scan命令遍历外部节点，一次获取1000条数据。")]),s._v(" "),e("li",[s._v("遍历这些key，计算出key对应的slot。")]),s._v(" "),e("li",[s._v("执行migrate命令,源节点是外部节点,目的节点是集群slot对应的节点，如果设置了--copy参数，则传递copy参数，如果设置了--replace，则传递replace参数。")]),s._v(" "),e("li",[s._v("不停执行scan命令，直到遍历完全部的key。")]),s._v(" "),e("li",[s._v("至此完成整个迁移流程")])]),s._v(" "),e("p",[s._v("这中间如果出现异常，程序就会停止。没使用--copy模式，则可以重新执行import命令，使用--copy的话，最好清空新的集群再导入一次。")]),s._v(" "),e("p",[s._v("import命令更适合离线的把外部redis数据导入，在线导入的话最好使用更专业的导入工具，以slave的方式连接redis节点去同步节点数据应该是更好的方式。")]),s._v(" "),e("p",[s._v("下面是一个例子")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("./redis-trib.rb "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("import")]),s._v(" --from "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.0")]),s._v(".10.1:6379 "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.10")]),s._v(".10.1:7000\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("上面的命令是把 10.0.10.1:6379（redis 2.8）上的数据导入到 10.10.10.1:7000这个节点所在的集群。")]),s._v(" "),e("p",[e("strong",[s._v("set-timeout设置集群节点间心跳连接的超时时间")])]),s._v(" "),e("p",[s._v("set-timeout用来设置集群节点间心跳连接的超时时间，单位是毫秒，不得小于100毫秒，因为100毫秒对于心跳时间来说太短了。该命令修改是节点配置参数cluster-node-timeout，默认是15000毫秒。通过该命令，可以给每个节点设置超时时间，设置的方式使用config set命令动态设置，然后执行config rewrite命令将配置持久化保存到硬盘。以下是示例：")]),s._v(" "),e("p",[e("strong",[s._v("call在集群全部节点上执行命令")])]),s._v(" "),e("p",[s._v("call命令可以用来在集群的全部节点执行相同的命令。call命令也是需要通过集群的一个节点地址，连上整个集群，然后在集群的每个节点执行该命令。")]),s._v(" "),e("h2",{attrs:{id:"集群客户端命令"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#集群客户端命令"}},[s._v("#")]),s._v(" 集群客户端命令")]),s._v(" "),e("ul",[e("li",[s._v("集群")])]),s._v(" "),e("p",[s._v("cluster info：打印集群的信息\ncluster nodes：列出集群当前已知的所有节点（node），以及这些节点的相关信息。")]),s._v(" "),e("ul",[e("li",[s._v("节点")])]),s._v(" "),e("p",[s._v("cluster meet"),e("ip",[e("port",[s._v(" ：将ip和port所指定的节点添加到集群当中，让它成为集群的一份子。\ncluster forget<node_id>：从集群中移除 node_id 指定的节点。\nclusterreplicate <node_id>：将当前节点设置为node_id指定的节点的从节点。\nclustersaveconfig：将节点的配置文件保存到硬盘里面。")])],1)],1),s._v(" "),e("ul",[e("li",[s._v("槽")])]),s._v(" "),e("p",[s._v("cluster addslots"),s._t("default",[s._v(" [slot ...]：将一个或多个槽（slot）指派（assign）给当前节点。\nclusterdelslots "),s._t("default",[s._v(" [slot ...]：移除一个或多个槽对当前节点的指派。\nclusterflushslots：移除指派给当前节点的所有槽，让当前节点变成一个没有指派任何槽的节点。\ncluster setslot"),s._t("default",[s._v(" node <node_id>：将槽 slot 指派给 node_id 指定的节点，如果槽已经指派给另一个节点，那么先让另一个节点删除该槽>，然后再进行指派。\ncluster setslot"),s._t("default",[s._v(" migrating <node_id>：将本节点的槽 slot 迁移到node_id 指定的节点中。\ncluster setslot"),s._t("default",[s._v(" importing <node_id>：从 node_id 指定的节点中导入槽slot 到本节点。\ncluster setslot"),s._t("default",[s._v(" stable：取消对槽 slot 的导入")])])])])])])],2),s._v(" "),e("ul",[e("li",[s._v("键")])]),s._v(" "),e("p",[s._v("cluster keyslot"),e("key",[s._v("：计算键 key 应该被放置在哪个槽上。\nclustercountkeysinslot "),s._t("default",[s._v("：返回槽 slot 目前包含的键值对数量。\nclustergetkeysinslot "),s._t("default",[e("count",[s._v("：返回 count 个 slot 槽中的键。")])])])],2)],1)])}),[],!1,null,null,null);t.default=r.exports}}]);