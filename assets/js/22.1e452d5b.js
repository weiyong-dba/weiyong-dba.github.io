(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{468:function(s,a,e){"use strict";e.r(a);var n=e(51),t=Object(n.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h2",{attrs:{id:"使用存贮过程维护分区"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#使用存贮过程维护分区"}},[s._v("#")]),s._v(" 使用存贮过程维护分区")]),s._v(" "),e("h3",{attrs:{id:"安装工具"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装工具"}},[s._v("#")]),s._v(" 安装工具")]),s._v(" "),e("p",[s._v("下载undrop-for-innodb")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("git clone https://github.com/twindb/undrop-for-innodb.git\nmake\nexport basedir=/usr/local/mysql3306/\ngcc `$basedir/bin/mysql_config --cflags` `$basedir/bin/mysql_config --libs` -o sys_parser sys_parser.c\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("ul",[e("li",[s._v("重要的工具： c_parser && stream_parser && sys_parser")]),s._v(" "),e("li",[s._v("其中 test.sh && recover_dictionary.sh && fetch_data.sh 是测试的脚本，可以看下里面的逻辑理解工具的用法。")]),s._v(" "),e("li",[s._v("三个目录")]),s._v(" "),e("li",[s._v("dictionary 里面是模拟 innodb 系统表结构写的 CREATE TABLE 语句，innodb 的系统表对用户不可见，可以在 informatioin_schema 表中找到一些值，但实际上系统表是保存在 ibdata 固定的页上的。")]),s._v(" "),e("li",[s._v("sakila 是一些 SQL 语句，用来测试用。")]),s._v(" "),e("li",[s._v("include 是从 innodb 拿出来的一些用到的头文件和源文件。")])]),s._v(" "),e("h3",{attrs:{id:"恢复表结构"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#恢复表结构"}},[s._v("#")]),s._v(" 恢复表结构")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("mysql> checksum table phonebook;\n+----------------+------------+\n| Table          | Checksum   |\n+----------------+------------+\n| test.phonebook | 3088212235 |\n+----------------+------------+\nmysql> drop table phonebook;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("p",[s._v("使用工具 stream_parser 解析文件$datadir/ibdata1内容。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("#./stream_parser -f /mysql/mysql3306/ibdata1\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("执行完毕后会在当前目录下生成文件夹 pages-ibdata1 , 目录下按照每个页为一个文件，分为索引页和数据较大的 BLOB 页，我们访问系统表的话，是存在索引页中的。使用另外一个重要的工具 c_parser 来解析页的内容。")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('./c_parser -4Df pages-ibdata1/FIL_PAGE_INDEX/0000000000000001.page -t dictionary/SYS_TABLES.sql  | grep \'test/phonebook\'\n0000000B2FF1    7D000008F609E9  SYS_TABLES      "test/phonebook"        7324    2       33      0       80      ""      1021\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[e("strong",[s._v("参数解析")])]),s._v(" "),e("ul",[e("li",[s._v("4 表示文件格式是 REDUNDANT，系统表的格式默认值。另外可以取值 5 表示 COMPACT 格式，6 表示 MySQL 5.6 格式。")]),s._v(" "),e("li",[s._v("D 表示只恢复被删除的记录。")]),s._v(" "),e("li",[s._v("f 后面跟着文件。")]),s._v(" "),e("li",[s._v("t 后面跟着 CREATE TABLE 语句，需要根据表的格式来解析文件。")])]),s._v(" "),e("p",[s._v("得到的结果 ‘SYS_TABLES’ 字段后面的就是系统表 SYS_TABLE 中对应存的记录。 同样的恢复其它三个系统表：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("/* --- SYS_INDEXES 'grep 7324' 是对应 SYS_TABLE 的 TALE ID --- */\n./c_parser -4Df pages-ibdata1/FIL_PAGE_INDEX/0000000000000003.page -t dictionary/SYS_INDEXES.sql  | grep '7324'\n0000000B2FF1    7D000008F60942  SYS_INDEXES     7324    3324    \"GEN\\_CLUST\\_INDEX\"     0       1       1021    4294967295\n\n/* --- SYS_COLUMNS --- */\n./c_parser -4Df pages-ibdata1/FIL_PAGE_INDEX/0000000000000002.page -t dictionary/SYS_COLUMNS.sql | grep 7324\n0000000B2FF1    7D000008F6097F  SYS_COLUMNS     7324    0       \"name\"  12      2953231 256     0\n0000000B2FF1    7D000008F609B4  SYS_COLUMNS     7324    1       \"phone\" 12      67436559        192     0\n\n/* --- SYS_FIELD  'grep 3324' 对应 SYS_INDEXES 的 ID 列 --- */\n./c_parser -4Df pages-ibdata1/FIL_PAGE_INDEX/0000000000000004.page -t dictionary/SYS_FIELDS.sql | grep '3324'\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("p",[e("strong",[s._v("使用工具 sys_parser 恢复 CREATE TABLE 语句")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("$./sys_parser -h 127.0.0.1 -u root -d recover test/phonebook\nCREATE TABLE `phonebook`(\n^^^\n) ENGINE=InnoDB;\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("h3",{attrs:{id:"恢复数据"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#恢复数据"}},[s._v("#")]),s._v(" 恢复数据")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("./stream_parser -f /dev/sda5 -s 1G -t 1142G\n./c_parser -6f pages-ibdata1/FIL_PAGE_INDEX/0000000000000065.page -t actor.sql\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])])])}),[],!1,null,null,null);a.default=t.exports}}]);