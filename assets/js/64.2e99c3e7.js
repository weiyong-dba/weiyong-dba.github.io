(window.webpackJsonp=window.webpackJsonp||[]).push([[64],{413:function(s,a,e){"use strict";e.r(a);var n=e(51),t=Object(n.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"mongodb运维手册"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#mongodb运维手册"}},[s._v("#")]),s._v(" mongodb运维手册")]),s._v(" "),e("h3",{attrs:{id:"删除分片"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#删除分片"}},[s._v("#")]),s._v(" 删除分片")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('db.runCommand({"removeshard" : "localhost:20002"});\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"删除重复数据"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#删除重复数据"}},[s._v("#")]),s._v(" 删除重复数据")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("db.userInfo.aggregate([\n    {\n        $group: { _id: {userName: '$userName',age: '$age'},count: {$sum: 1},dups: {$addToSet: '$_id'}}\n    },\n    {\n        $match: {count: {$gt: 1}}\n    }\n]).forEach(function(doc){\n    doc.dups.shift();\n    db.userInfo.remove({_id: {$in: doc.dups}});\n})\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("ol",[e("li",[s._v("根据userName和age分组并统计数量，$group只会返回参与分组的字段，使用$addToSet在返回结果数组中增加_id字段")]),s._v(" "),e("li",[s._v("使用$match匹配数量大于1的数据")]),s._v(" "),e("li",[s._v("doc.dups.shift();表示从数组第一个值开始删除；作用是踢除重复数据其中一个_id，让后面的删除语句不会删除所有数据")]),s._v(" "),e("li",[s._v("使用forEach循环根据_id删除数据")])]),s._v(" "),e("p",[s._v("$addToSet 操作符只有在值没有存在于数组中时才会向数组中添加一个值。如果值已经存在于数组中，$addToSet返回，不会修改数组。")]),s._v(" "),e("p",[e("strong",[s._v("注意：")]),s._v("\nforEach和$addToSet的驼峰写法不能全部写成小写，因为mongodb严格区分大小写、mongodb严格区分大小写、mongodb严格区分大小写，重要的事情说三遍！")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("my_mongodb_0:PRIMARY> function readAndUpdate(dbName, colName, no_recs, iter) {    var col = db.getSiblingDB(dbName).getCollection(colName);  var doc=null; print(Math.round(new Date().getTime()/1000));   for (i = 0; i < iter; i++) { rand=Math.floor((Math.random()*no_recs)+1);   doc=col.findOne({x:rand},{y:1}); if(doc==null) continue; y=doc.y; new_y=y+rand;\ncol.update({x:rand}, { $set: {y: new_y } });   }     print(Math.round(new Date().getTime()/1000));  }\nmy_mongodb_0:PRIMARY> readAndUpdate('test','johan',1000000, 10000000)\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("h3",{attrs:{id:"删除用户"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#删除用户"}},[s._v("#")]),s._v(" 删除用户")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("db.users.remove({})\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"强制主从切换"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#强制主从切换"}},[s._v("#")]),s._v(" 强制主从切换")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("cfg = rs.conf()\ncfg.members[0].priority = 0.5\ncfg.members[1].priority = 2\ncfg.members[2].priority = 2\nrs.reconfig(cfg)\nrs.reconfig(cnf,{force:true})\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("h3",{attrs:{id:"备份恢复"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#备份恢复"}},[s._v("#")]),s._v(" 备份恢复")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("mongodump --host 127.0.0.1:27017 -u root -p xxxx --authenticationDatabase=admin --oplog -o /tmp/aaa\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("h3",{attrs:{id:"创建用户"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#创建用户"}},[s._v("#")]),s._v(" 创建用户")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('use admin\ndb.createUser(\n  {\n    user: "root",\n    pwd: "",\n    roles: [ { role: "__system", db: "admin" } ]\n  }\n)\n\nuse db1\ndb.createUser(\n   {\n     user: "rwuser",\n     pwd: "",\n     roles: [ "readWrite","dbAdmin","dbOwner"]\n   }\n)\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br")])]),e("h3",{attrs:{id:"获取参数"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#获取参数"}},[s._v("#")]),s._v(" 获取参数")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("db.adminCommand({getParameter:'*'})\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])])])}),[],!1,null,null,null);a.default=t.exports}}]);