(window.webpackJsonp=window.webpackJsonp||[]).push([[66],{411:function(s,t,a){"use strict";a.r(t);var n=a(51),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"mongodb高可用配置之replicat-set"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mongodb高可用配置之replicat-set"}},[s._v("#")]),s._v(" Mongodb高可用配置之Replicat Set")]),s._v(" "),a("h2",{attrs:{id:"总体规划"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#总体规划"}},[s._v("#")]),s._v(" 总体规划")]),s._v(" "),a("ul",[a("li",[s._v("primary: 1个，端口为27017。")]),s._v(" "),a("li",[s._v("secondaries: 1个，端口为27017。")]),s._v(" "),a("li",[s._v("arbiter: 1个，端口为27017。")]),s._v(" "),a("li",[s._v("启用mongodb认证")])]),s._v(" "),a("h2",{attrs:{id:"配置keyfile"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置keyfile"}},[s._v("#")]),s._v(" 配置keyfile")]),s._v(" "),a("ol",[a("li",[s._v("生成keyfile文件 - "),a("code",[s._v("openssl rand -base64 756 >rs01.key")])]),s._v(" "),a("li",[s._v("把keyfile文件copy到其他节点")]),s._v(" "),a("li",[s._v("修改keyfile文件权限为400 - "),a("code",[s._v("chmod 400 keyfile")])])]),s._v(" "),a("h2",{attrs:{id:"配置replset"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置replset"}},[s._v("#")]),s._v(" 配置replset")]),s._v(" "),a("ol",[a("li",[s._v("编辑mongo启动配置文件"),a("code",[s._v("start.sh")])])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("/usr/local/mongodb27017/bin/mongod --dbpath /usr/local/mongodb27017/data/rs01 --replSet rs01 --logpath /usr/local/mongodb27017/log/rs01.log --port 27017 --logappend --fork --auth --keyFile /usr/local/mongodb27017/rs01.key\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ol",{attrs:{start:"2"}},[a("li",[s._v("启动mongodb - "),a("code",[s._v("bash start.sh")])]),s._v(" "),a("li",[s._v("初始化replica set")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('rs.initiate({"_id" : "rs27017", "members" : [{_id: 0, host: "172.0.0.1:27017"}, {_id: 1, host: "172.0.0.2:27017"},{_id:2,host:"172.0.0.3:27017",arbiterOnly:true}]})\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("ol",{attrs:{start:"4"}},[a("li",[s._v("登录mongo执行"),a("code",[s._v("rs.status()")]),s._v("查看状态")])]),s._v(" "),a("h2",{attrs:{id:"创建用户"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#创建用户"}},[s._v("#")]),s._v(" 创建用户")]),s._v(" "),a("ol",[a("li",[s._v("创建超级用户")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('use admin\ndb.createUser(\n  {\n    user: "root",\n    pwd: "",\n    roles: [ { role: "__system", db: "admin" } ]\n  }\n)\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("ol",{attrs:{start:"2"}},[a("li",[s._v("创建普通用户")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('use admin\ndb.auth(\'root\',\'pwd\')\nuse test\ndb.createUser(\n   {\n     user: "rwuser",\n     pwd: "",\n     roles: [ "readWrite","dbAdmin","dbOwner"]\n   }\n)\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("h2",{attrs:{id:"配置日志清理脚本"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#配置日志清理脚本"}},[s._v("#")]),s._v(" 配置日志清理脚本")]),s._v(" "),a("p",[s._v("该脚本的目的是按天保持日志文件。")]),s._v(" "),a("div",{staticClass:"language-python line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#!/bin/env python")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" sys\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" os\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" commands\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" datetime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("time\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#change log")]),s._v("\nnlog "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" commands"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("getoutput"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"/bin/ls --full-time /usr/local/mongodb27017/log/|awk '{print $6, $9}'\"")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#clean log which > 10 days")]),s._v("\nstr_now "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" time"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("strftime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%Y-%m-%d"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ndat_now "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" time"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("strptime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("str_now"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%Y-%m-%d"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\narray_dat_now "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" datetime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("datetime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("dat_now"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("dat_now"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("dat_now"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\ncplog "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" commands"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("getoutput"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/bin/cp /usr/local/mongodb27017/log/rs02.log /usr/local/mongodb27017/log/rs02-%s.log"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("str_now"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nflushlog "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" commands"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("getoutput"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('":> /usr/local/mongodb27017/log/rs02.log"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nlns "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" commands"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("getoutput"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"/bin/ls --full-time /usr/local/mongodb27017/log/|awk '{print $6, $9}'\"")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" ln "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" lns"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("split"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'\\n'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    ws "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ln"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("split"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[s._v("len")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ws"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("continue")]),s._v("\n    ws1 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" time"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("strptime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ws"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"%Y-%m-%d"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    ws2 "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" datetime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("datetime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ws1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("ws1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("ws1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("array_dat_now "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" ws2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("days "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n        v_del "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" commands"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("getoutput"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/bin/ls /usr/local/mongodb27017/log/%s"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("%")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("ws"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br")])]),a("h2",{attrs:{id:"获得一致性备份"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#获得一致性备份"}},[s._v("#")]),s._v(" 获得一致性备份")]),s._v(" "),a("ul",[a("li",[s._v("备份 - "),a("code",[s._v("mongodump --host 127.0.0.1:27017 -u root -p xxx --authenticationDatabase=admin --oplog -o /tmp")])]),s._v(" "),a("li",[s._v("还原 - "),a("code",[s._v("mongorestore --host 127.0.0.1:27017 -u root -p xxx --authenticationDatabase=admin --oplogReplay /tmp/aaa/")])])])])}),[],!1,null,null,null);t.default=e.exports}}]);