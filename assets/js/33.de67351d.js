(window.webpackJsonp=window.webpackJsonp||[]).push([[33],{444:function(s,t,a){"use strict";a.r(t);var e=a(51),r=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"postgresql流复制配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#postgresql流复制配置"}},[s._v("#")]),s._v(" PostgreSQL流复制配置")]),s._v(" "),a("h3",{attrs:{id:"安装pg软件"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#安装pg软件"}},[s._v("#")]),s._v(" 安装PG软件")]),s._v(" "),a("p",[s._v("在备节点上安装相同版本的PG软件，详见"),a("RouterLink",{attrs:{to:"/pages/859ac7/"}},[s._v("通过源码编译安装PostgreSQL")]),s._v("。")],1),s._v(" "),a("h3",{attrs:{id:"全量备份"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#全量备份"}},[s._v("#")]),s._v(" 全量备份")]),s._v(" "),a("p",[s._v("在备库上执行全量备份命令")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("pg_basebackup -X stream -R -c fast -D /pgsql/pgsql5432/ -h 主库IP -p "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5432")]),s._v(" -U repl -P\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"流复制配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#流复制配置"}},[s._v("#")]),s._v(" 流复制配置")]),s._v(" "),a("p",[s._v("编辑recovery.conf")]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("standby_mode "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" on\nprimary_conninfo "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'host=主库IP port=5432 user=repl password=xxxxxx'")]),s._v("\nrecovery_target_timeline "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'latest'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#trigger_file = '/pgsql/pgsql5432/trigger.unl'")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#recovery_target_time = '2018-09-06 19:40:18.910572+08' #应用到这个时间点后数据库变成主库，不能再次恢复，注意")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("启动服务即可。")]),s._v(" "),a("p",[a("strong",[s._v("区分主备")])]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" pg_is_in_recovery"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"复制延迟监控"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#复制延迟监控"}},[s._v("#")]),s._v(" 复制延迟监控")]),s._v(" "),a("ol",[a("li",[s._v("创建"),a("strong",[s._v("heartbeat")]),s._v("表")])]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" heartbeat"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("uptime "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("timestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" heartbeat "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("ol",{attrs:{start:"2"}},[a("li",[s._v("创建心跳监控shell脚本"),a("strong",[s._v("heartbeat.sh")])])]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" heartbeat"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("uptime "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("timestamp")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" heartbeat "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("ol",{attrs:{start:"3"}},[a("li",[s._v("增加"),a("strong",[s._v("crontab")]),s._v("定时任务")])]),s._v(" "),a("div",{staticClass:"language-shell line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[s._v("* * * * * "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("bash")]),s._v(" /home/postgres/heartbeat.sh "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("/dev/null "),a("span",{pre:!0,attrs:{class:"token operator"}},[a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("2")]),s._v(">")]),a("span",{pre:!0,attrs:{class:"token file-descriptor important"}},[s._v("&1")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])])])}),[],!1,null,null,null);t.default=r.exports}}]);