(window.webpackJsonp=window.webpackJsonp||[]).push([[42],{474:function(s,a,e){"use strict";e.r(a);var t=e(51),n=Object(t.a)({},(function(){var s=this,a=s.$createElement,e=s._self._c||a;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"scylladb高可用部署"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#scylladb高可用部署"}},[s._v("#")]),s._v(" ScyllaDB高可用部署")]),s._v(" "),e("h2",{attrs:{id:"常用网址"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#常用网址"}},[s._v("#")]),s._v(" 常用网址")]),s._v(" "),e("ul",[e("li",[s._v("官方网址\nhttps://www.scylladb.com")]),s._v(" "),e("li",[s._v("Github\nhttps://github.com/scylladb")]),s._v(" "),e("li",[s._v("Google user list\nhttps://groups.google.com/forum/#!forum/scylladb-users")]),s._v(" "),e("li",[s._v("Scylladb dev list\nhttps://groups.google.com/forum/#!forum/scylladb-dev")]),s._v(" "),e("li",[s._v("Seastar dev list\nhttps://groups.google.com/forum/#!forum/seastar-dev")]),s._v(" "),e("li",[s._v("Kairosdb group list\nhttps://groups.google.com/forum/#!forum/kairosdb-group")])]),s._v(" "),e("h2",{attrs:{id:"硬件需求"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#硬件需求"}},[s._v("#")]),s._v(" 硬件需求")]),s._v(" "),e("table",[e("thead",[e("tr",[e("th",[s._v("Installation")]),s._v(" "),e("th",[s._v("Cores")]),s._v(" "),e("th",[s._v("Memory")]),s._v(" "),e("th",[s._v("Disk")]),s._v(" "),e("th",[s._v("Network")])])]),s._v(" "),e("tbody",[e("tr",[e("td",[s._v("Test, minimal")]),s._v(" "),e("td",[s._v("4")]),s._v(" "),e("td",[s._v("2 GB")]),s._v(" "),e("td",[s._v("Single plain SSD")]),s._v(" "),e("td",[s._v("1 Gbps")])]),s._v(" "),e("tr",[e("td",[s._v("Production")]),s._v(" "),e("td",[s._v("20 cores - 2 socket，10 cores each")]),s._v(" "),e("td",[s._v("128 GB")]),s._v(" "),e("td",[s._v("RAID-0, 4 SSDs, 1-5 TBs")]),s._v(" "),e("td",[s._v("10 Gbps")])]),s._v(" "),e("tr",[e("td",[s._v("Analytics, heavy duty")]),s._v(" "),e("td",[s._v("28 cores - 2 socket, 14 cores each")]),s._v(" "),e("td",[s._v("256 GB - 1 TB")]),s._v(" "),e("td",[s._v("NVMe, 10 TB")]),s._v(" "),e("td",[s._v("10-56 Gbps")])])])]),s._v(" "),e("p",[e("strong",[s._v("实测单块SSD性能")])]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("disks:\n  - mountpoint: /var/lib/scylla/data\n    read_iops: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("269435")]),s._v("\n    read_bandwidth: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2931620096")]),s._v("\n    write_iops: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("244322")]),s._v("\n    write_bandwidth: "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("2399274496")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("h2",{attrs:{id:"安装scylladb"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装scylladb"}},[s._v("#")]),s._v(" 安装scylladb")]),s._v(" "),e("p",[s._v("安装scylladb时，机器能连外网，有几个步骤需要：")]),s._v(" "),e("ol",[e("li",[s._v("运行scylla_setup 时，ntp选项")]),s._v(" "),e("li",[s._v("运行scylla_setup时，检测是否有新版本时")]),s._v(" "),e("li",[s._v("运行scylla_setup 时，node-exporter选项，这个也可以先跳过，安装安装后修改"),e("code",[s._v("/usr/sbin/node_exporter_install")]),s._v("中下载地址为内网地址后再运行"),e("code",[s._v("node_exporter_install")]),s._v("安装即可。")])]),s._v(" "),e("p",[e("strong",[s._v("开始安装")])]),s._v(" "),e("ol",[e("li",[s._v("yum remove -y abrt gcc-gnat")]),s._v(" "),e("li",[s._v("sudo wget -O /etc/yum.repos.d/scylla.repo http://repositories.scylladb.com/scylla/repo/146c1863e35dde22ea5e12cc16607478/centos/scylladb-2.0.repo (这个换成要安装的版本号，只要大版本号就行，例如2.1,2.2等)。")]),s._v(" "),e("li",[s._v("curl -o /etc/yum.repos.d/scylla.repo -L http://repositories.scylladb.com/scylla/repo/2809e983-e3b9-49c7-bdc4-1a09c55b8bb4/centos/scylladb-3.0.repo(3.0版本)")]),s._v(" "),e("li",[s._v("yum install python34-six python-backports-ssl_match_hostname -y")]),s._v(" "),e("li",[s._v("rpm -ivh python3-pyudev-0.21.0-1.el7.noarch.rpm")]),s._v(" "),e("li",[s._v("sudo yum install scylla")]),s._v(" "),e("li",[s._v("sudo yum install scylla-debug*(需要调试才安装这个)")]),s._v(" "),e("li",[s._v("sudo yum install scylla-gdb*(Scylla 自己的gdb，需要调试才安装)")]),s._v(" "),e("li",[s._v("yum -y install --downloadonly --downloaddir=/etc/yum.repos.d/abc scylla-gdb")]),s._v(" "),e("li",[s._v("yum install python34-six")])]),s._v(" "),e("p",[e("strong",[s._v("安装特定版本")]),s._v(" -\n"),e("code",[s._v("sudo yum install scylla-1.7.1")]),s._v("(这个换成特定的版本号)")]),s._v(" "),e("h2",{attrs:{id:"配置scylla"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#配置scylla"}},[s._v("#")]),s._v(" 配置scylla")]),s._v(" "),e("ol",[e("li",[e("p",[s._v("在每个节点运行"),e("code",[s._v("scylla_setup")]),s._v("，大部分都选yes，创建文件系统时，要选择SSD盘符（fdisk –l获取）")])]),s._v(" "),e("li",[e("p",[s._v("配置"),e("code",[s._v("/etc/scylla/scylla.yaml")])]),s._v(" "),e("ul",[e("li",[s._v("cluster_name - 这个改成和项目相关的一个名字，如果是测试系统，默认值就行。\n"),e("ul",[e("li",[e("code",[s._v("sed -i \"s/\\#cluster_name: 'Test Cluster'/cluster_name: 'my-scylladb'/g\" /etc/scylla/scylla.yaml")])])])]),s._v(" "),e("li",[s._v("data_file_directories - 数据目录值，默认值就行，除非自己创建文件系统，自己mount到某个特定的目录。")]),s._v(" "),e("li",[s._v("commitlog_directory - 日志目录值，默认值就行，如果机器上有两个ssd盘，其中一个小容量的ssd盘可以分配给日志目录，这样就需要自己指定一个特定的值。")]),s._v(" "),e("li",[s._v('seeds - "1.1.1.1,11.1.1.2,1.1.1.3" 这个要换成自己集群的机器的IP地址，一般从集群中选3个机器就行。\n'),e("ul",[e("li",[e("code",[s._v('sed -i \'s/seeds: \\"127.0.0.1\\"/seeds: \\"1.1.1.1,11.1.1.2,1.1.1.3\\"/g\' /etc/scylla/scylla.yaml')])])])]),s._v(" "),e("li",[s._v("listen_address - 本机IP地址\n"),e("ul",[e("li",[e("code",[s._v("sed -i 's/listen_address: localhost/listen_address: '\"$local_ip\"'/g' /etc/scylla/scylla.yaml")])])])]),s._v(" "),e("li",[s._v("rpc_address - 本机IP地址\n"),e("ul",[e("li",[e("code",[s._v("sed -i 's/rpc_address: localhost/rpc_address: '\"$local_ip\"'/g' /etc/scylla/scylla.yaml")])])])]),s._v(" "),e("li",[s._v("api_address - 本机IP地址\n"),e("ul",[e("li",[e("code",[s._v("sed -i 's/api_address: 127.0.0.1/api_address: '\"$local_ip\"'/g' /etc/scylla/scylla.yaml")])])])]),s._v(" "),e("li",[s._v("auto_snapshot - false，如果在每次drop/truncate keyspace或者table后，不想保留原来的数据，可以设置为false。默认是生成snapshot目录的，这样每次drop/truncate操作后，需要手动在每个节点上手动删除相应的snapshot目录，比较麻烦。但如果确实需要保存旧的数据，这个就保留默认的值。\n"),e("ul",[e("li",[e("code",[s._v("sed -i 's/# auto_snapshot: true/auto_snapshot: false/g' /etc/scylla/scylla.yaml")])])])])])]),s._v(" "),e("li",[e("p",[s._v("禁用更新检查"),e("code",[s._v("/etc/scylla.d/housekeeping.cfg")])]),s._v(" "),e("ul",[e("li",[s._v("check-version: False\n"),e("ul",[e("li",[e("code",[s._v("sed -i 's/check-version: True/check-version: False/g' /etc/scylla.d/housekeeping.cfg")])])])])])]),s._v(" "),e("li",[e("p",[s._v("修改服务超时时间"),e("code",[s._v("/lib/systemd/system/scylla-server.service")]),s._v(" 的TimeoutStartSec=3600")])])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("sed -i 's/TimeoutStartSec=900/TimeoutStartSec=3600/g' /lib/systemd/system/scylla-server.service\nsystemctl daemon-reload\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ol",{attrs:{start:"3"}},[e("li",[e("p",[s._v("启动/关闭/重启scylla服务")]),s._v(" "),e("ul",[e("li",[s._v("sudo service scylla-server start")]),s._v(" "),e("li",[s._v("sudo service scylla-server stop")]),s._v(" "),e("li",[s._v("sudo service scylla-server restart")])])]),s._v(" "),e("li",[e("p",[s._v("cqlsh操作")]),s._v(" "),e("p",[s._v("在一台主机上运行"),e("code",[s._v("cqlsh")]),s._v("主机IP，进入cqlsh shell界面：")])])]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("cqlsh "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172")]),s._v(".xx.xx.xx\ncqlsh"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\ndesc keyspaces 查看所有的keyspace：\ncqlsh"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" desc keyspaces"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nsystem_traces  system_schema  system  stream  hbase\n\n进入某个keyspace：\ncqlsh"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" use hbase "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\ncqlsh:hbase"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n\n查看keyspace所有的table：\ncqlsh:hbase"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" desc hbase"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])]),e("ol",{attrs:{start:"5"}},[e("li",[s._v("配置scylla")])]),s._v(" "),e("p",[s._v("server的全局配置参数"),e("code",[s._v("/etc/sysconfig/scylla-server")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('SCYLLA_ARGS="--log-to-syslog 1 --log-to-stdout 0 --default-log-level info --collectd-address=127.0.0.1:25826 --collectd=1 --collectd-poll-period 3000 --network-stack posix --background-writer-scheduling-quota=0.3 --auto-adjust-flush-quota=true"\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("最后background-writer-scheduling-quota是说compaction write占cpu的比例，这个是为了减少客户端请求的延迟，--auto-adjust-flush-quota=true是配置memtable自动flush，这两个参数是2.1以后才有。一般情况无需更改这个配置文件，更改后需要重启scylla服务。")]),s._v(" "),e("ol",{attrs:{start:"6"}},[e("li",[s._v("查看scylla的系统日志")])]),s._v(" "),e("p",[s._v("执行")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("journalctl -xe _COMM=Scylla`，可以加until 和since选项查看某个特定时间段的日志，在Centos上，也可以直接查询 /var/log/messages查看包括scylla在内的整个系统日志。\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("ol",{attrs:{start:"7"}},[e("li",[s._v("定位backtrace栈的内容：")])]),s._v(" "),e("p",[s._v("如果在系统log里发现如下内容：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("scylla: Reactor stalled for 2012 ms on shard 6.\nscylla: Backtrace:\nscylla: 0x00000000004eef58\nscylla: 0x00000000004ef239\nscylla: 0x00007fc8745dd0ff\nscylla: 0x0000000000ba0fdf\nscylla: 0x0000000000b86f03\nscylla: 0x0000000000b8101f\nscylla: 0x0000000000b820a5\nscylla: 0x0000000000b821b5\nscylla: 0x0000000000b4a120\nscylla: 0x0000000000b4aa51\nscylla: 0x0000000000bc936b\nscylla: 0x0000000000bcd167\nscylla: 0x0000000000bcd748\nscylla: 0x0000000000bae9c0\nscylla: 0x0000000000b99c01\nscylla: 0x0000000000bb583d\nscylla: 0x0000000000550a2c\nscylla: 0x00000000004ecd0f\nscylla: 0x000000000054083a\nscylla: 0x00000000005420e0\nscylla: 0x000000000059a54d\nscylla: 0x00007fc8745d5dc4\nscylla: 0x00007fc874302cec\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br")])]),e("p",[s._v("可以运行下面类似的命令来打印出问题时栈对应的函数：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[s._v("addr2line -Cfpi -e /usr/lib/debug/usr/bin/scylla.debug 0x00000000004eef58 0x00000000004ef239 0x00007fc8745dd0ff 0x0000000000ba0fdf 0x0000000000b86f03 0x0000000000b8101f 0x0000000000b820a5 0x0000000000b821b5  0x0000000000b4a120 0x0000000000b4aa51 0x0000000000bc936b 0x0000000000bcd167 0x0000000000bcd748 0x0000000000bae9c0 0x0000000000b99c01 0x0000000000bb583d 0x0000000000550a2c 0x00000000004ecd0f 0x000000000054083a 0x00000000005420e0 0x000000000059a54d 0x00007fc8745d5dc4 0x00007fc874302cec\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("这里16进制的地址信息换成对应的真实地址。")]),s._v(" "),e("ol",{attrs:{start:"9"}},[e("li",[s._v("运行nodetool工具")])]),s._v(" "),e("p",[s._v("运行nodetool工具需要java 1.8版本或更高版本，一般安装scylla rpm包后会自动安装，需要配置一下,"),e("code",[s._v(".bash_profile")]),s._v("里面加上：")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("export")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("JAVA_HOME")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.161-0.b14.el7_4.x86_64/jre"')]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[e("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("PATH")])]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$PATH")]),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),e("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("$HOME")]),s._v("/bin\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ul",[e("li",[e("code",[s._v("nodetool tablehistograms")]),s._v(" - 可以看某个table的运行历史信息，主要看分片大小和延迟。")]),s._v(" "),e("li",[e("code",[s._v("nodetool flush")]),s._v(" - 可以强制把内存中memtable flush到磁盘上")]),s._v(" "),e("li",[e("code",[s._v("nodetool getlogginglevels/setlogginglevel")]),s._v(" - 查询和设置logging level，默认的level就行，这个主要在查问题时需要，一次最好只打开一个模块的，会对性能有很大影响，不要在生产系统使用。")])]),s._v(" "),e("h2",{attrs:{id:"安装scylladb监控"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装scylladb监控"}},[s._v("#")]),s._v(" 安装scylladb监控")]),s._v(" "),e("p",[s._v("详见"),e("RouterLink",{attrs:{to:"/2019/09/17/scylla-monitor-install/"}},[s._v("安装scylla-grafana-monitoring")])],1),s._v(" "),e("h2",{attrs:{id:"压测"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#压测"}},[s._v("#")]),s._v(" 压测")]),s._v(" "),e("p",[s._v("cassandra-stress是客户端压力测试工具")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("nohup")]),s._v(" cassandra-stress user "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("profile")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/root/test.yaml "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("duration")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("100h "),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'ops(insert=7,events=3)'")]),s._v(" -pop "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("seq")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("30000000000")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("40000000000")]),s._v(" -mode native cql3 -rate "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("threads")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("3000")]),s._v(" -node "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("172")]),s._v(".x.x.1,172.x.x.2,172.x.x.3 "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&>")]),s._v(" /dev/null "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("在文件test.yaml可以模拟生产系统的schema，在命令行ops里指定写和读的比例，threads指定有多少线程在运行，duration指定运行时间，更详细的命令参数可以看help，下面是我自己写的test.yaml内容：")]),s._v(" "),e("div",{staticClass:"language-yaml line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-yaml"}},[e("code",[e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("keyspace")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("keyspace_definition")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),e("span",{pre:!0,attrs:{class:"token scalar string"}},[s._v("\n CREATE KEYSPACE test WITH replication = {'class': 'SimpleStrategy', 'replication_factor': '2'}  AND durable_writes = true;")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("table")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" test_20171121\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("table_definition")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("|")]),e("span",{pre:!0,attrs:{class:"token scalar string"}},[s._v("\n  CREATE TABLE test_20171121 (\n        id text,\n        datatime int,\n        features text,\n        PRIMARY KEY (id, datatime)\n  ) WITH CLUSTERING ORDER BY (datatime DESC)\n   AND bloom_filter_fp_chance = 0.01\n   AND caching = {'keys': 'ALL','rows_per_partition': 'ALL'}\n   AND comment = ''\n   AND compaction = {'class': 'SizeTieredCompactionStrategy'}\n   AND compression = {'sstable_compression': 'org.apache.cassandra.io.compress.LZ4Compressor'}\n   AND dclocal_read_repair_chance = 0.1\n   AND default_time_to_live = 604800\n   AND gc_grace_seconds = 0\n   AND max_index_interval = 2048\n   AND memtable_flush_period_in_ms = 0\n   AND min_index_interval = 128\n   AND speculative_retry = '99.0PERCENTILE';")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("columnspec")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" id\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("size")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" fixed(120)\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("population")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" uniform(1..1000000000000)\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" datatime\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("size")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" fixed(120)\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cluster")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" fixed(1)\n  "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" features\n    "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("size")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" fixed(120)\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("insert")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("partitions")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" fixed(1)\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("batchtype")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" UNLOGGED\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("select")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" fixed(1)/1\n"),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("queries")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("events")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n   "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cql")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" select * from test_20171121 where id = "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("?")]),s._v(" limit 1\n   "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("fields")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" samerow\n  "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("latest_event")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n   "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("cql")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" select * from test_20171121 where id = "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("?")]),s._v(" LIMIT 1\n   "),e("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("fields")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" samerow\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br")])]),e("p",[s._v("这里columnspec: 规范内容里，可以指定每个字段的大小（size），对于clustering key, 可以指定 cluster属性，表示一个partition里有多少个clustering key，可以测试一个partition里有很多行的情况。")]),s._v(" "),e("h2",{attrs:{id:"安装scylla-manager"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#安装scylla-manager"}},[s._v("#")]),s._v(" 安装scylla-manager")]),s._v(" "),e("div",{staticClass:"language-shell line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-shell"}},[e("code",[e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -o /etc/yum.repos.d/scylla-manager.repo -L http://repositories.scylladb.com/scylla/repo/2809e983-e3b9-49c7-bdc4-1a09c55b8bb4/centos/scylladb-manager-1.3.repo\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -o /etc/yum.repos.d/scylla.repo -L http://repositories.scylladb.com/scylla/repo/2809e983-e3b9-49c7-bdc4-1a09c55b8bb4/centos/scylladb-manager-1.2.repo\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" yum "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" scylla-manager-server scylla-manager-client\nyum -y "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" --downloadonly --downloaddir"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/yum.repos.d/abc scylla-manager-server scylla-manager-client\nscyllamgr_setup\nsystemctl start scylla-manager.service\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("h2",{attrs:{id:"scylla连接池配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#scylla连接池配置"}},[s._v("#")]),s._v(" scylla连接池配置")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("＃本地主机的最小连接（同一数据中心中的一个）\ncoreConnectionsPerLocalHost：1\n＃本地主机的最大连接数（同一数据中心中的一个）\nmaxConnectionsPerLocalHost：1\n＃远程主机的最小连接（远程数据中心中的一个）\ncoreConnectionsPerRemoteHost：1\n＃远程主机（同一数据中心中的一个）的最大连接数\nmaxConnectionsPerRemoteHost：1\n＃每个本地连接（同一数据中心中的一个）的最大并发请求数\nmaxRequestsPerLocalConnection：32768\n＃每个远程连接的最大并发请求数（远程数据中心中的一个）\nmaxRequestsPerRemoteConnection：2048\n＃触发打开新本地连接的请求数（如果有）\nnewLocalConnectionThreshold：30000\n＃触发打开新的远程连接的请求数（如果有）\nnewRemoteConnectionThreshold：400\n＃等待获取连接的毫秒数（此后转到查询计划中的下一个可用主机）\npoolTimeoutMillis：0\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br")])])])}),[],!1,null,null,null);a.default=n.exports}}]);