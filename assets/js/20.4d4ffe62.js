(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{466:function(s,a,t){"use strict";t.r(a);var e=t(51),r=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"主从复制搭建及错误处理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#主从复制搭建及错误处理"}},[s._v("#")]),s._v(" 主从复制搭建及错误处理")]),s._v(" "),t("h2",{attrs:{id:"前言"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),t("p",[s._v("很多时候生产库一开始没有搭建slave，运行一段时间后感觉不稳妥，晚上开始有点睡不着了，一大早来上班兴冲冲开始搭建slave，本文将带你get这项让你夜晚可以安睡的技能，详细介绍如何为生成库增加slave，开搞。")]),s._v(" "),t("h2",{attrs:{id:"工具准备"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#工具准备"}},[s._v("#")]),s._v(" 工具准备")]),s._v(" "),t("ul",[t("li",[s._v("innobackupex")])]),s._v(" "),t("h2",{attrs:{id:"备份master"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#备份master"}},[s._v("#")]),s._v(" 备份Master")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("nohup")]),s._v(" innobackupex –defaults-file"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("/etc/my.cnf –lock-wait-timeout"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("300")]),s._v(" –slave-info –safe-slave-backup –parallel"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" –user"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("backup –password"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("backuppass –parallel"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" /tmp/2019-09-12_15-00-00 "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("备份结束后，将整个备份目录"),t("code",[s._v("2019-09-12_15-00-00")]),s._v("复制到slave。")]),s._v(" "),t("h2",{attrs:{id:"恢复slave"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#恢复slave"}},[s._v("#")]),s._v(" 恢复slave")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /tmp/2019-09-12_15-00-00\ninnobackupex –apply-log –parallel"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(".")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("在slave机器上安装相同版本的mysql，假设数据目录是"),t("code",[s._v("/mysql/mysql3306")]),s._v("。")]),s._v(" "),t("blockquote",[t("p",[s._v("mv 2019-09-12_15-00-00 /mysql/mysql3306")])]),s._v(" "),t("p",[s._v("启动mysql server")]),s._v(" "),t("h2",{attrs:{id:"配置slave"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#配置slave"}},[s._v("#")]),s._v(" 配置slave")]),s._v(" "),t("p",[s._v("在数据目录中找到"),t("code",[s._v("xtrabackup_binlog_info")]),s._v("文件，该文件记录了binlog的位置。\n如：")]),s._v(" "),t("blockquote",[t("p",[s._v("mysql-bin.000001        40488")])]),s._v(" "),t("p",[s._v("登录slave，执行"),t("code",[s._v("change master to")]),s._v("命令。")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("CHANGE MASTER "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TO")]),s._v("\n  MASTER_HOST"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'master ip'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  MASTER_USER"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'repl'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  MASTER_PASSWORD"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'repl'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  MASTER_PORT"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3306")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  MASTER_LOG_FILE"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql-bin.000001'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n  MASTER_LOG_POS"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("40488")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("启动slave")]),s._v(" "),t("blockquote",[t("p",[s._v("start slave;")])]),s._v(" "),t("p",[s._v("检查是否成功")]),s._v(" "),t("blockquote",[t("p",[s._v("show slave status\\G;")])]),s._v(" "),t("p",[s._v("IO、SQL状态都是Yes，即为成功。")]),s._v(" "),t("ul",[t("li",[s._v("Slave_IO_Running: Yes")]),s._v(" "),t("li",[s._v("Slave_SQL_Running: Yes")])]),s._v(" "),t("h2",{attrs:{id:"移除slave"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#移除slave"}},[s._v("#")]),s._v(" 移除slave")]),s._v(" "),t("p",[s._v("要移除slave，执行"),t("code",[s._v("reset slave all")]),s._v("即可。")]),s._v(" "),t("h2",{attrs:{id:"跳过错误"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#跳过错误"}},[s._v("#")]),s._v(" 跳过错误")]),s._v(" "),t("h3",{attrs:{id:"_5-6版本解决方法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-6版本解决方法"}},[s._v("#")]),s._v(" 5.6版本解决方法")]),s._v(" "),t("p",[t("strong",[s._v("方法一：忽略错误后，继续同步")])]),s._v(" "),t("p",[s._v("该方法适用于主从库数据相差不大，或者要求数据可以不完全统一的情况，数据要求不严格的情况。")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("stop slave"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("global")]),s._v(" sql_slave_skip_counter"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#表示跳过一步错误，后面的数字可变")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("start")]),s._v(" slave"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n之后再用"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" slave "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("status")]),s._v("\\G"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("查看\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[t("strong",[s._v("方式二：重新做主从，完全同步")])]),s._v(" "),t("p",[s._v("该方法适用于主从数据库相差较大，或者要求数据完全统一的情况")]),s._v(" "),t("h3",{attrs:{id:"_5-7版本解决方法"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_5-7版本解决方法"}},[s._v("#")]),s._v(" 5.7版本解决方法")]),s._v(" "),t("p",[t("strong",[s._v("解决方法一：跳过错误")])]),s._v(" "),t("p",[s._v("1、停止slave进程")]),s._v(" "),t("blockquote",[t("p",[s._v("stop slave;")])]),s._v(" "),t("p",[s._v("2、设置事务号，事务号从Retrieved_Gtid_Set获取,在session里设置gtid_next，即跳过这个GTID")]),s._v(" "),t("blockquote",[t("p",[s._v("set  @@SESSION.GTID_NEXT= '85ff3269-b54d-11e7-97a8-fa163e66866b:5';")])]),s._v(" "),t("p",[s._v("3、设置空事务")]),s._v(" "),t("blockquote",[t("p",[s._v("begin;")]),s._v(" "),t("p",[s._v("commit;")])]),s._v(" "),t("p",[s._v("4、恢复事务号")]),s._v(" "),t("blockquote",[t("p",[s._v("set session gtid_next=automatic;")])]),s._v(" "),t("p",[s._v("5、启动slave进程")]),s._v(" "),t("blockquote",[t("p",[s._v("start slave;")])]),s._v(" "),t("p",[t("strong",[s._v("解决方法二：重置master方法跳过错误")])]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("stop slave"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\nreset master"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v("  @"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("@glocal.gtid_purged")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'5ff3269-b54d-11e7-97a8-fa163e66866b:5'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("start")]),s._v(" slave"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[t("strong",[s._v("解决方案三：使用pt-slave-restart工具")])]),s._v(" "),t("p",[s._v("pt-slave-restart工具的作用是监视某些特定的复制错误，然后忽略，然后再次启动slave进程,例如：忽略所有1062错误，并再次启动slave进程")]),s._v(" "),t("div",{staticClass:"language-shell line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[s._v("pt-slave-restart  -S  /mysql/mysqld.sock  --error-numbers"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1062")]),s._v("  --user"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("root  --password"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"后记"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#后记"}},[s._v("#")]),s._v(" 后记")]),s._v(" "),t("p",[s._v("本文介绍了如何基于master的备份创建slave的方法，基于slave的备份创建slave的方法也是一样的，只是binlog位置需要从文件"),t("code",[s._v("xtrabackup_slave_info")]),s._v("获取而不是"),t("code",[s._v("xtrabackup_binlog_info")]),s._v("，只有在备份的时候增加slave-info选项才会产生"),t("code",[s._v("xtrabackup_slave_info")]),s._v("文件。")])])}),[],!1,null,null,null);a.default=r.exports}}]);